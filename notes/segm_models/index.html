<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Language" content="en">

    <meta name="author" content="Leonid Gremyachikh">
    <meta name="description" content="Image segmentation models.">
    <meta name="keywords" content="blog,developer,personal,research,researcher,machine learning,deep learning,computer vision,reinforcement learning">

    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Segmentation models"/>
<meta name="twitter:description" content="Image segmentation models."/>

    <meta property="og:title" content="Segmentation models" />
<meta property="og:description" content="Image segmentation models." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bamasa.github.io/notes/segm_models/" />
<meta property="article:published_time" content="2022-01-06T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-01-06T00:00:00+00:00" />





    <title>
  Segmentation models · Leonid Gremyachikh
</title>

    
      <link rel="canonical" href="https://bamasa.github.io/notes/segm_models/">
    

    <link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.1.7/css/fork-awesome.min.css" integrity="sha256-gsmEoJAws/Kd3CjuOQzLie5Q3yshhvmo7YNtBG7aaEY=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin="anonymous" />

    
      
      
      <link rel="stylesheet" href="/css/coder.min.3ef54d6d0ced5b90be5efca8d3d546c7a1e833e55b95cfdfd9a2daf1170ae312.css" integrity="sha256-PvVNbQztW5C&#43;Xvyo09VGx6HoM&#43;Vblc/f2aLa8RcK4xI=" crossorigin="anonymous" media="screen" />
    

    

    
      
        
        
        <link rel="stylesheet" href="/css/coder-dark.min.717236c74e0a5208ef73964a9f44c6b443b689a95b270d8b2a40d0c012460dac.css" integrity="sha256-cXI2x04KUgjvc5ZKn0TGtEO2ialbJw2LKkDQwBJGDaw=" crossorigin="anonymous" media="screen" />
      
    

    
      <link rel="stylesheet" href="/css/add.css" />
    

    

    <link rel="icon" type="image/png" href="/images/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/images/favicon-16x16.png" sizes="16x16">

    <link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

    
      <script src="https://twemoji.maxcdn.com/v/latest/twemoji.min.js" crossorigin="anonymous"></script>
    

    <meta name="generator" content="Hugo 0.76.3" />
  </head>

  
  
    
  
  <body class="colorscheme-auto"
        onload=" twemoji.parse(document.body); "
  >
    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="/">
      Leonid Gremyachikh
    </a>
    
      
        <span id="dark-mode-toggle" class="float-right">
          <i class="fa fa-adjust fa-fw" aria-hidden="true"></i>
        </span>
      
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link" href="/works/">Projects</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="/notes/">Notes</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="/log/">Log</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="/about/">About</a>
            </li>
          
        
        
        
          <li class="navigation-item separator">
            <span>|</span>
          </li>
        
      </ul>
    
  </section>
</nav>


      <div class="content">
        
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">Segmentation models</h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fa fa-calendar" aria-hidden="true"></i>
              <time datetime='2022-01-06T00:00:00Z'>
                January 6, 2022
              </time>
            </span>
            <span class="reading-time">
              <i class="fa fa-clock-o" aria-hidden="true"></i>
              4-minute read
            </span>
          </div>
          
          <div class="tags">
  <i class="fa fa-tag" aria-hidden="true"></i>
    <a href="/tags/computer-vision/">computer vision</a>
      <span class="separator">•</span>
    <a href="/tags/models/">models</a>
      <span class="separator">•</span>
    <a href="/tags/segmentation/">segmentation</a></div>

        </div>
      </header>


      <div>
        
        <!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<h1 id="tl-dr">TL; DR</h1>
<p>Сегментация это</p>
<p>Если надо сделать то берешь последние модели:</p>
<ul>
<li>maskrcnn  (такие плюсы такие минусы)</li>
<li>&hellip;  (такие плюсы такие минусы)</li>
</ul>
<h1 id="definitions">Definitions</h1>
<p><em>Semantic segmentation</em> – segment category, like car.<br>
<em>Instance segmentation</em> – segment individual instances, like Toyota Camry and Skoda Octavia.<br>
<em>Panoptic Segmentation</em> –</p>
<p><em>Backbone</em> – the feature extractor network. Then these features are upsampled by a simple decoder module of DeepLab models to generate segmented masks. (DeepLab term)</p>
<h1 id="detectron">Detectron</h1>
<h1 id="pointrend">PointRend</h1>
<p>Detectron2 Train a Instance Segmentation Model</p>
<p><a href="https://gilberttanner.com/blog/detectron2-train-a-instance-segmentation-model">https://gilberttanner.com/blog/detectron2-train-a-instance-segmentation-model</a></p>
<p><a href="https://wendeehsu.medium.com/instance-segmentation-with-detectron2-127fbe01b20b">https://wendeehsu.medium.com/instance-segmentation-with-detectron2-127fbe01b20b</a></p>
<h3 id="poind-based-inference-via-subdivision">Poind-based inference via subdivision:</h3>
<ul>
<li>? где мы это берем ? какой первый шаг? через rcnn?</li>
<li>lower resolution prediction is unsampled with bilinear interpolation</li>
<li>select the subset of the most uncertain points</li>
<li>for each selected point refine using a lightweight MLP (independently)</li>
</ul>
<p>в итоге мы быстро и дешево увеличиваем разрешение сегментации</p>
<h3 id="poindrend-for-the-instance-segmentation">Poindrend for the instance segmentation</h3>
<p>// semantic segmentation can be done in a similar way</p>
<ul>
<li>CNN backbone</li>
<li>for each detected bounding box make low-resolution mask prediction</li>
<li>use coarse prediction wet find points which we want to refine</li>
<li>for the obtained points subset, we extract features from the coarse prediction and the backbone features using bilineal interpolation</li>
<li>use an MLP for the each point</li>
</ul>
<!-- raw HTML omitted -->
<h3 id="poindrend-for-the-semantic-segmentation">Poindrend for the semantic segmentation</h3>
<p>// semantic segmentation can be done in a similar way</p>
<ul>
<li>the approach can be applied on top fo any modern segmentation model</li>
<li></li>
</ul>
<h3 id="conclusion">Conclusion</h3>
<ul>
<li>high resolution output little to no computational overhead</li>
<li>&ldquo;plug &amp; play&rdquo; on top of any FCN-based model for segmentation</li>
<li>significant quantitative and qualitative improvement</li>
</ul>
<hr>
<p>instance and semantic segmentation</p>
<p>uses a subdivision strategy to adaptively select a non-uniform set of points at which to compute labels.</p>
<p>PointRend can be incorporated into popular meta-architectures for both instance segmentation (e.g. Mask R-CNN) and semantic segmentation (e.g. FCN).</p>
<p>Its subdivision strategy efficiently computes high-resolution segmentation maps using an order of magnitude fewer floating-point operations than direct, dense computation.</p>
<p>Авторы предлагают элегантное решение проблемы низкого разрешения масок в сегментации с помощью адаптивного алгоритма, который уточняет маску в тех местах, где она недостаточно точная. Метод может быть применен поверх других алгоритмов, увеличивая как визуальное качество, так и AP (average precision).</p>
<figure>
    <img src="/files/blog/segm/pointrend.png" width="50%"/> 
</figure>

<p>На проблему сегментации предлагается посмотреть как на проблему рендеринга: мы пытаемся получить из (непрерывного) occupancy map предмета или класса &ldquo;рендерить&rdquo; регулярную сетку (пикселей) маски сегментации. PointRend берет маску низкого разрешения, апсемплит и уточняет ее в определенных точках. Так как большая часть маски не требует уточнения, эти точки расположены в основном на границе маски. Таким образом, для увеличения разрешения маски в два раза мы не классифицируем в четыре раза больше пикселей.</p>
<p>Во время инференса используется техника, которая называется adaptive subdivision. Для начала feature map апсемплится стандартным билинеарным апсемплингом. Далее, N точек с самой близкой к 0.5 вероятностью принадлежности к маске прогоняются через MLP (с общими весами для всех точек и регионов) и для них генерируются новые фичи. Процесс повторяется пока не достигается необходимое разрешение, и требует N * log (M/M_0) предсказаний вместо M^2 (M — входной размер, M0 — размер первого шага, N — количество обрабатываемых граничных точек).</p>
<p>Из-за итеративности процесса, бекпропогейшн через него работает не очень хорошо. Вместо этого, авторы сэмплируют точки из распределения, которое смещено в сторону точек с низким confidence.</p>
<p>В качестве фич для точек используется конкатенация высокоуровневых фич (предсказание сети о классе этой точки) и низкоуровневых (фичи из одного или нескольких фичермапов CNN).</p>
<p>Для экспериментов авторы использовали Mask R-CNN с ResNet-50 + FPN. Голову для предсказания масок заменили на более эффективную которая предсказывает маску 7x7. Кроме того, на вход масочной головы во время трейнинга подавали выход головы для bounding box, что не улучшило Mask R-CNN, но улучшило PointRend за счет более качественного семплирования точек. В итоге оверхед по флопсам по сравнению с Mask R-CNN с масками 28x28 почти в 2 раза (0.5 vs. 0.9 GFLOPS), но конечно не сравним с масками 224x224 (34 GFLOPS).</p>
<p>Так как PointRend улучшает качество масок на границах, значительного улучшения по AP не наблюдается. Но на датасете с более точными масками (LVIS) профит выше. Авторы провели неплохой ablation study: количество точек на каждом этапе (N), итоговое разрешение маски, тип семплирования во время тренинга, а также разные архитектуры и увеличение времени тренировки.</p>
<p>Алгоритм также протестировали на семантической сегментации, поверх DeeplabV3 и SemanticFPN. Опять таки, по mIoU профит небольшой, но сетка восстанавливает мелкие детали и визуально разница заметна.</p>
<h3 id="todo">TODO:</h3>
<ul>
<li>? обучать mask rcnn на небольшом разрешении, потом юзать pointrend</li>
<li>главный профит на границах</li>
<li>смотреть видосы</li>
</ul>
<h3 id="links">Links</h3>
<ul>
<li><a href="">original paper</a></li>
<li><a href="https://paperswithcode.com/method/pointrend#:~:text=PointRend%20is%20a%20module%20for,at%20which%20to%20compute%20labels.">paper with code</a></li>
<li><a href="https://habr.com/en/company/ods/blog/515688/">ODS blog</a></li>
</ul>

      </div>


      <footer>
        

<section class="see-also">
  
    
    
    
      <h3>See also in computer vision</h3>
      <nav>
        <ul>
        
        
          
            <li>
              <a href="/own_projects/meta_deity/">Meta-Deity</a>
            </li>
          
        
          
            <li>
              <a href="/projects/cv_teeth/">3D Computer Vision for teeth</a>
            </li>
          
        
          
            <li>
              <a href="/notes/cv_startups/">Computer Vision Startups</a>
            </li>
          
        
          
            <li>
              <a href="/own_projects/one_script_models/">One script models</a>
            </li>
          
        
          
            <li>
              <a href="/projects/img_gen/">NFT Images Generator</a>
            </li>
          
        
          
        
        </ul>
      </nav>
    
  
    
    
    
  
    
    
    
  
</section>


        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "bamasa" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        
        
      </footer>
    </article>

    

      <section class="container centered">
      <div class="about">
        
        <ul>
          
            
              <li>
                <a href="https://t.me/bamasa" aria-label="Telegram"   >
                  <i class="fa fa-telegram" aria-hidden="true"></i>
                </a>
              </li>
            
          
            
              <li>
                <a href="https://github.com/bamasa/" aria-label="Github"   >
                  <i class="fa fa-github" aria-hidden="true"></i>
                </a>
              </li>
            
          
            
              <li>
                <a href="https://gitlab.com/bamasa/" aria-label="Gitlab"   >
                  <i class="fa fa-gitlab" aria-hidden="true"></i>
                </a>
              </li>
            
          
            
              <li>
                <a href="mailto:lgremyachikh@gmail.com" aria-label="Email"   >
                  <i class="fa fa-envelope" aria-hidden="true"></i>
                </a>
              </li>
            
          
            
              <li>
                <a href="https://instagram.com/bamasa.lg" aria-label="Instagram" rel="alternate"  type="application/rss&#43;xml">
                  <i class="fa fa-instagram" aria-hidden="true"></i>
                </a>
              </li>
            
          
            
              <li>
                <a href="https://bamasa.github.io/files/Leonid_Gremyachikh_CV.pdf" aria-label="CV"   >
                  <i class="fa fa-address-card" aria-hidden="true"></i>
                </a>
              </li>
            
          
        </ul>
        
      </div>
    </section> 
  </section>

      </div>

      
    </main>

    
      
      <script src="/js/dark-mode.min.0213e1773e6d1c5a644f847c67a6f8abac49a3776e2976f6008038af8c5b76a1.js"></script>
    

    

    

    

    

    <script data-goatcounter="https://code.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>

  </body>

</html>
